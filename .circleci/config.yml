---
version: 2.1

executors:
  docker-executor:
    docker:
      - image: docker:18
  shellcheck-executor:
    docker:
      - image: opennms/shellcheck:0.5.0-b1

commands:
  dockerhub-login:
    description: "Connect to DockerHub"
    steps:
      - run:
          name: Login to DockerHub
          command: |
            docker login -u ${DOCKERHUB_LOGIN} -p ${DOCKERHUB_PASS}

  script-env-alpine:
    description: "Add bash support in Alpine based images"
    steps:
      - run:
          name: Add Bash support
          command: |
            apk add --no-cache bash python

workflows:
  build-publish:
    jobs:
      - shellcheck
      - build-oci-image:
          requires:
            - shellcheck
      - publish-oci-image:
          requires:
            - build-oci-image
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - master
                - develop

jobs:
  shellcheck:
    executor: shellcheck-executor
    steps:
      - checkout
      - run:
          name: Shellcheck Scripts
          command: |
            find . -type f -name '*.sh' | wc -l
            find . -type f -name '*.sh' | xargs shellcheck --external-sources -e SC2129,SC2001,SC2013

  build-oci-image:
    executor: docker-executor
    steps:
      - script-env-alpine
      - checkout
      - setup_remote_docker
      - run:
          name: Build Horizon OCI image
          command: |
            ./build_container_image.sh
      - store_artifacts:
          path: ~/project/images/horizon-core-web.oci
          destination: horizon-core-web.oci
      - persist_to_workspace:
          root: ~/
          paths:
            - project

  publish-oci-image:
    executor: docker-executor
    steps:
      - attach_workspace:
          at: ~/
      - setup_remote_docker
      - script-env-alpine
      - dockerhub-login
      - run:
          name: Load Horizon OCI image
          command: |
            docker image load -i images/horizon-core-web.oci
      - run:
          name: Tag and publish Horizon OCI image
          command: |
            ./tag-n-push.sh
